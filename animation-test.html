<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åŠ¨ç”»æµ‹è¯•é¡µé¢</title>
  <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.155.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.155.0/examples/jsm/"
        }
    }
    </script>
  <style>
    body {
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      font-family: 'Arial', sans-serif;
      color: white;
    }

    #container {
      width: 100%;
      height: 80vh;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 10px;
      background: rgba(0, 0, 0, 0.2);
    }

    .controls {
      margin: 20px 0;
      text-align: center;
    }

    .btn {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: 10px 20px;
      margin: 5px;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }

    .info {
      background: rgba(0, 0, 0, 0.3);
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
    }

    .animation-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin: 20px 0;
    }

    .animation-item {
      background: rgba(255, 255, 255, 0.1);
      padding: 10px;
      border-radius: 5px;
      text-align: center;
    }

    .animation-item.playing {
      background: rgba(76, 175, 80, 0.3);
      border: 1px solid #4CAF50;
    }

    #log {
      background: rgba(0, 0, 0, 0.5);
      padding: 10px;
      border-radius: 5px;
      height: 200px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
      white-space: pre-wrap;
    }
  </style>
</head>

<body>
  <h1>ğŸµ Lofi FM åŠ¨ç”»æµ‹è¯•å·¥å…·</h1>

  <div class="info">
    <h3>ğŸ“‹ æµ‹è¯•è¯´æ˜</h3>
    <p>æ­¤é¡µé¢ç”¨äºæµ‹è¯• record_player_ani.glb æ¨¡å‹çš„æ‰€æœ‰åŠ¨ç”»æ•ˆæœ</p>
    <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ¥æ’­æ”¾ä¸åŒçš„åŠ¨ç”»ï¼Œè§‚å¯ŸåŠ¨ç”»æ˜¯å¦æ­£å¸¸æ’­æ”¾å’Œåˆ‡æ¢</p>
  </div>

  <div class="controls">
    <button class="btn" onclick="loadModel()">ğŸ”„ åŠ è½½æ¨¡å‹</button>
    <button class="btn" onclick="stopAllAnimations()">â¹ï¸ åœæ­¢æ‰€æœ‰åŠ¨ç”»</button>
    <button class="btn" onclick="clearLog()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
  </div>

  <div class="controls">
    <h3>ğŸµ éŸ³ä¹æ’­æ”¾æ¨¡æ‹Ÿ</h3>
    <button class="btn" onclick="playMusicSequence()" id="playBtn">â–¶ï¸ æ’­æ”¾éŸ³ä¹</button>
    <button class="btn" onclick="stopMusicSequence()" id="stopBtn">â¹ï¸ åœæ­¢éŸ³ä¹</button>
    <div id="sequenceStatus" style="margin-top: 10px; font-weight: bold;">çŠ¶æ€: å¾…æœº</div>
  </div>

  <div id="container"></div>

  <div class="info">
    <h3>ğŸ¬ å¯ç”¨åŠ¨ç”»åˆ—è¡¨</h3>
    <div id="animationList" class="animation-list">
      <div class="animation-item">åŠ è½½æ¨¡å‹åæ˜¾ç¤º...</div>
    </div>
  </div>

  <div class="info">
    <h3>ğŸ“ è¿è¡Œæ—¥å¿—</h3>
    <div id="log"></div>
  </div>

  <script type="module">
    import * as THREE from 'three';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    // å…¨å±€å˜é‡
    let scene, camera, renderer, controls;
    let model, mixer;
    let animations = {};
    let clock = new THREE.Clock();
    let currentPlayingAnimation = null;

    // æ—¥å¿—å‡½æ•°
    function log(message) {
      const logElement = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      logElement.textContent += `[${timestamp}] ${message}\n`;
      logElement.scrollTop = logElement.scrollHeight;
      console.log(message);
    }

    // æ¸…ç©ºæ—¥å¿—
    window.clearLog = function () {
      document.getElementById('log').textContent = '';
    }

    // åˆå§‹åŒ–Three.jsåœºæ™¯
    function initScene() {
      const container = document.getElementById('container');

      // åœºæ™¯
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x222222);

      // ç›¸æœº
      camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
      camera.position.set(0, 2, 5);

      // æ¸²æŸ“å™¨
      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(container.clientWidth, container.clientHeight);
      renderer.shadowMap.enabled = true;
      renderer.shadowMap.type = THREE.PCFSoftShadowMap;
      container.appendChild(renderer.domElement);

      // æ§åˆ¶å™¨
      controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;

      // å…‰ç…§
      const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
      scene.add(ambientLight);

      const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
      directionalLight.position.set(5, 10, 5);
      directionalLight.castShadow = true;
      scene.add(directionalLight);

      // åœ°é¢
      const planeGeometry = new THREE.PlaneGeometry(20, 20);
      const planeMaterial = new THREE.MeshLambertMaterial({ color: 0x333333 });
      const plane = new THREE.Mesh(planeGeometry, planeMaterial);
      plane.rotation.x = -Math.PI / 2;
      plane.receiveShadow = true;
      scene.add(plane);

      log('Three.js åœºæ™¯åˆå§‹åŒ–å®Œæˆ');
    }

    // åŠ è½½æ¨¡å‹
    window.loadModel = function () {
      log('å¼€å§‹åŠ è½½æ¨¡å‹...');

      const loader = new GLTFLoader();
      loader.load(
        './model/record_player_ani.glb',
        function (gltf) {
          // ç§»é™¤æ—§æ¨¡å‹
          if (model) {
            scene.remove(model);
          }

          model = gltf.scene;
          model.scale.set(1, 1, 1);
          model.position.set(0, 0, 0);

          // å¯ç”¨é˜´å½±
          model.traverse(function (child) {
            if (child.isMesh) {
              child.castShadow = true;
              child.receiveShadow = true;
            }
          });

          scene.add(model);
          log(`æ¨¡å‹åŠ è½½æˆåŠŸï¼ŒåŒ…å« ${gltf.animations.length} ä¸ªåŠ¨ç”»`);

          // è®¾ç½®åŠ¨ç”»
          setupAnimations(gltf);
        },
        function (progress) {
          const percent = (progress.loaded / progress.total * 100).toFixed(1);
          log(`åŠ è½½è¿›åº¦: ${percent}%`);
        },
        function (error) {
          log(`æ¨¡å‹åŠ è½½å¤±è´¥: ${error.message}`);
        }
      );
    }

    // è®¾ç½®åŠ¨ç”»
    function setupAnimations(gltf) {
      if (gltf.animations && gltf.animations.length > 0) {
        mixer = new THREE.AnimationMixer(model);
        animations = {};

        gltf.animations.forEach(anim => {
          const action = mixer.clipAction(anim);
          animations[anim.name] = {
            action: action,
            duration: anim.duration,
            name: anim.name
          };
          log(`æ³¨å†ŒåŠ¨ç”»: ${anim.name}, æ—¶é•¿: ${anim.duration.toFixed(2)}s`);
        });

        updateAnimationList();
        log('æ‰€æœ‰åŠ¨ç”»è®¾ç½®å®Œæˆ');
      } else {
        log('æ¨¡å‹ä¸­æ²¡æœ‰æ‰¾åˆ°åŠ¨ç”»æ•°æ®');
      }
    }

    // æ›´æ–°åŠ¨ç”»åˆ—è¡¨UI
    function updateAnimationList() {
      const listElement = document.getElementById('animationList');
      listElement.innerHTML = '';

      Object.keys(animations).forEach(animName => {
        const item = document.createElement('div');
        item.className = 'animation-item';
        item.innerHTML = `
                    <strong>${animName}</strong><br>
                    <small>æ—¶é•¿: ${animations[animName].duration.toFixed(2)}s</small><br>
                    <button class="btn" onclick="playAnimation('${animName}')">â–¶ï¸ æ’­æ”¾</button>
                    <button class="btn" onclick="stopAnimation('${animName}')">â¹ï¸ åœæ­¢</button>
                `;
        listElement.appendChild(item);
      });
    }

    // æ’­æ”¾åŠ¨ç”»
    window.playAnimation = function (animName) {
      if (!animations[animName]) {
        log(`åŠ¨ç”» ${animName} ä¸å­˜åœ¨`);
        return;
      }

      const anim = animations[animName];
      anim.action.reset();
      anim.action.setLoop(THREE.LoopOnce);
      anim.action.clampWhenFinished = true;
      anim.action.play();

      // æ›´æ–°UIçŠ¶æ€
      updateAnimationUI(animName, true);
      currentPlayingAnimation = animName;

      log(`æ’­æ”¾åŠ¨ç”»: ${animName}`);

      // ç›‘å¬åŠ¨ç”»å®Œæˆäº‹ä»¶
      const onFinished = () => {
        log(`åŠ¨ç”» ${animName} æ’­æ”¾å®Œæˆ`);
        updateAnimationUI(animName, false);
        if (currentPlayingAnimation === animName) {
          currentPlayingAnimation = null;
        }
        mixer.removeEventListener('finished', onFinished);
      };

      mixer.addEventListener('finished', onFinished);
    }

    // åœæ­¢åŠ¨ç”»
    window.stopAnimation = function (animName) {
      if (!animations[animName]) {
        log(`åŠ¨ç”» ${animName} ä¸å­˜åœ¨`);
        return;
      }

      animations[animName].action.stop();
      updateAnimationUI(animName, false);
      log(`åœæ­¢åŠ¨ç”»: ${animName}`);
    }

    // åœæ­¢æ‰€æœ‰åŠ¨ç”»
    window.stopAllAnimations = function () {
      Object.keys(animations).forEach(animName => {
        animations[animName].action.stop();
        updateAnimationUI(animName, false);
      });
      currentPlayingAnimation = null;
      isPlayingMusic = false;
      updateSequenceStatus('å¾…æœº');
      log('åœæ­¢æ‰€æœ‰åŠ¨ç”»');
    }

    // éŸ³ä¹æ’­æ”¾çŠ¶æ€
    let isPlayingMusic = false;
    let musicSequenceTimeouts = [];

    // æ›´æ–°åºåˆ—çŠ¶æ€æ˜¾ç¤º
    function updateSequenceStatus(status) {
      document.getElementById('sequenceStatus').textContent = `çŠ¶æ€: ${status}`;
    }

    // æ¸…é™¤æ‰€æœ‰å®šæ—¶å™¨
    function clearMusicTimeouts() {
      musicSequenceTimeouts.forEach(timeout => clearTimeout(timeout));
      musicSequenceTimeouts = [];
    }

    // æ’­æ”¾éŸ³ä¹åºåˆ—
    window.playMusicSequence = function () {
      if (isPlayingMusic) {
        log('éŸ³ä¹å·²åœ¨æ’­æ”¾ä¸­');
        return;
      }

      if (!mixer || Object.keys(animations).length === 0) {
        log('è¯·å…ˆåŠ è½½æ¨¡å‹');
        return;
      }

      isPlayingMusic = true;
      clearMusicTimeouts();
      updateSequenceStatus('æ’­æ”¾ä¸­');
      log('å¼€å§‹æ’­æ”¾éŸ³ä¹åºåˆ—');

      // 1. æ’­æ”¾ button_down
      if (animations['button_down']) {
        playAnimation('button_down');
        log('æ­¥éª¤1: æ’­æ”¾ button_down åŠ¨ç”»');

        // 2. ç­‰å¾… button_down å®Œæˆåæ’­æ”¾ stylus_On
        const buttonDuration = animations['button_down'].duration * 1000;
        const timeout1 = setTimeout(() => {
          if (!isPlayingMusic) return;

          if (animations['stylus_On']) {
            playAnimation('stylus_On');
            log('æ­¥éª¤2: æ’­æ”¾ stylus_On åŠ¨ç”»');

            // 3. ç­‰å¾… stylus_On å®Œæˆåæ’­æ”¾ stylus_playing
            const stylusOnDuration = animations['stylus_On'].duration * 1000;
            const timeout2 = setTimeout(() => {
              if (!isPlayingMusic) return;

              if (animations['stylus_playing']) {
                // å¾ªç¯æ’­æ”¾ stylus_playing
                const anim = animations['stylus_playing'];
                anim.action.reset();
                anim.action.setLoop(THREE.LoopRepeat);
                anim.action.play();
                updateAnimationUI('stylus_playing', true);
                log('æ­¥éª¤3: å¼€å§‹å¾ªç¯æ’­æ”¾ stylus_playing åŠ¨ç”»');
                updateSequenceStatus('éŸ³ä¹æ’­æ”¾ä¸­ (å¾ªç¯)');
              }
            }, stylusOnDuration);
            musicSequenceTimeouts.push(timeout2);
          }
        }, buttonDuration);
        musicSequenceTimeouts.push(timeout1);
      } else {
        log('è­¦å‘Š: button_down åŠ¨ç”»ä¸å­˜åœ¨');
      }
    }

    // åœæ­¢éŸ³ä¹åºåˆ—
    window.stopMusicSequence = function () {
      if (!isPlayingMusic) {
        log('éŸ³ä¹æœªåœ¨æ’­æ”¾');
        return;
      }

      isPlayingMusic = false;
      clearMusicTimeouts();
      updateSequenceStatus('åœæ­¢ä¸­');
      log('å¼€å§‹åœæ­¢éŸ³ä¹åºåˆ—');

      // åœæ­¢å½“å‰æ’­æ”¾çš„åŠ¨ç”»
      ['button_down', 'stylus_On', 'stylus_playing'].forEach(animName => {
        if (animations[animName]) {
          animations[animName].action.stop();
          updateAnimationUI(animName, false);
        }
      });

      // æ’­æ”¾ stylus_Off åŠ¨ç”»
      if (animations['stylus_Off']) {
        playAnimation('stylus_Off');
        log('æ’­æ”¾ stylus_Off åŠ¨ç”»');

        // ç­‰å¾… stylus_Off å®Œæˆ
        const stylusOffDuration = animations['stylus_Off'].duration * 1000;
        setTimeout(() => {
          stopAnimation('stylus_Off');
          updateSequenceStatus('å¾…æœº');
          log('éŸ³ä¹åºåˆ—åœæ­¢å®Œæˆ');
        }, stylusOffDuration);
      } else {
        updateSequenceStatus('å¾…æœº');
        log('è­¦å‘Š: stylus_Off åŠ¨ç”»ä¸å­˜åœ¨ï¼Œåºåˆ—åœæ­¢å®Œæˆ');
      }
    }

    // æ›´æ–°åŠ¨ç”»UIçŠ¶æ€
    function updateAnimationUI(animName, isPlaying) {
      const items = document.querySelectorAll('.animation-item');
      items.forEach(item => {
        if (item.innerHTML.includes(animName)) {
          if (isPlaying) {
            item.classList.add('playing');
          } else {
            item.classList.remove('playing');
          }
        }
      });
    }

    // æ¸²æŸ“å¾ªç¯
    function animate() {
      requestAnimationFrame(animate);

      const delta = clock.getDelta();

      if (mixer) {
        mixer.update(delta);
      }

      controls.update();
      renderer.render(scene, camera);
    }

    // çª—å£å¤§å°è°ƒæ•´
    function onWindowResize() {
      const container = document.getElementById('container');
      camera.aspect = container.clientWidth / container.clientHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(container.clientWidth, container.clientHeight);
    }

    // åˆå§‹åŒ–
    window.addEventListener('load', () => {
      initScene();
      animate();
      log('åŠ¨ç”»æµ‹è¯•å·¥å…·åˆå§‹åŒ–å®Œæˆ');
      log('è¯·ç‚¹å‡»"åŠ è½½æ¨¡å‹"æŒ‰é’®å¼€å§‹æµ‹è¯•');
    });

    window.addEventListener('resize', onWindowResize);
  </script>
</body>

</html>